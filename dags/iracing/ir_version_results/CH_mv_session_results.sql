CREATE OR REPLACE TABLE iracing_stg.stg_mv_session_results (
    subsession_id Int NOT NULL,
    simsession_number Int NOT NULL,
    simsession_name String NOT NULL,
    simsession_type Int NOT NULL,
    simsession_type_name String NOT NULL,
    cust_id Int NOT NULL,
    display_name String NOT NULL,
    club_id Int NOT NULL,
    club_name String NOT NULL,
    club_shortname String NOT NULL,
    country_code String NOT NULL,
    friend UInt8 NOT NULL,
    ai UInt8 NOT NULL,
    car_id Int NOT NULL,
    car_name String NOT NULL,
    car_class_id Int NOT NULL,
    car_class_name String NOT NULL,
    car_class_short_name String NOT NULL,
    position Int NOT NULL,
    finish_position Int NOT NULL,
    finish_position_in_class Int NOT NULL,
    starting_position Int NOT NULL,
    starting_position_in_class Int NOT NULL,
    laps_complete Int NOT NULL,
    laps_lead Int NOT NULL,
    opt_laps_complete Int NOT NULL,
    incidents Int NOT NULL,
    `interval` Float64 NOT NULL,
    class_interval Float64 NOT NULL,
    reason_out String NOT NULL,
    reason_out_id Int NOT NULL,
    weight_penalty_kg Float64 NOT NULL,
    average_lap Float64 NOT NULL,
    best_lap_num Int NOT NULL,
    best_lap_time Float64 NOT NULL,
    best_nlaps_num Int NOT NULL,
    best_nlaps_time Float64 NOT NULL,
    qual_lap_time Float64 NOT NULL,
    best_qual_lap_num Int NOT NULL,
    best_qual_lap_time Float64 NOT NULL,
    best_qual_lap_at DateTime NOT NULL,
    champ_points Float64 NOT NULL,
    aggregate_champ_points Float64 NOT NULL,
    club_points Float64 NOT NULL,
    league_points Float64 NOT NULL,
    league_agg_points Float64 NOT NULL,
    drop_race UInt8 NOT NULL,
    multiplier Float64 NOT NULL,
    oldi_rating Int NOT NULL,
    newi_rating Int NOT NULL,
    old_ttrating Int NOT NULL,
    new_ttrating Int NOT NULL,
    old_license_level Int NOT NULL,
    new_license_level Int NOT NULL,
    old_sub_level Int NOT NULL,
    new_sub_level Int NOT NULL,
    old_cpi Float64 NOT NULL,
    new_cpi Float64 NOT NULL,
    license_change_oval UInt8 NOT NULL,
    license_change_road UInt8 NOT NULL,
    watched UInt8 NOT NULL,
    max_pct_fuel_fill Float64 NOT NULL,
    loaddate DateTime NOT NULL
) ENGINE = MergeTree()
ORDER BY (subsession_id, simsession_number, simsession_type, cust_id)
    AS
WITH latest_records AS (
    SELECT *,
           row_number() OVER (
               PARTITION BY subsession_id, simsession_number, simsession_type, cust_id, loaddate
               ORDER BY loaddate
           ) AS load_rank,
           row_number() OVER (
               PARTITION BY subsession_id, simsession_number, simsession_type, cust_id
               ORDER BY loaddate DESC
           ) AS overall_rank
    FROM iracing.session_results
)
SELECT
    subsession_id,
    simsession_number,
    simsession_name,
    simsession_type,
    simsession_type_name,
    cust_id,
    display_name,
    club_id,
    club_name,
    club_shortname,
    country_code,
    friend,
    ai,
    car_id,
    car_name,
    car_class_id,
    car_class_name,
    car_class_short_name,
    position,
    finish_position,
    finish_position_in_class,
    starting_position,
    starting_position_in_class,
    laps_complete,
    laps_lead,
    opt_laps_complete,
    incidents,
    `interval`,
    class_interval,
    reason_out,
    reason_out_id,
    weight_penalty_kg,
    average_lap,
    best_lap_num,
    best_lap_time,
    best_nlaps_num,
    best_nlaps_time,
    qual_lap_time,
    best_qual_lap_num,
    best_qual_lap_time,
    best_qual_lap_at,
    champ_points,
    aggregate_champ_points,
    club_points,
    league_points,
    league_agg_points,
    drop_race,
    multiplier,
    oldi_rating,
    newi_rating,
    old_ttrating,
    new_ttrating,
    old_license_level,
    new_license_level,
    old_sub_level,
    new_sub_level,
    old_cpi,
    new_cpi,
    license_change_oval,
    license_change_road,
    watched,
    max_pct_fuel_fill,
    loaddate
FROM latest_records
WHERE load_rank = 1
  AND overall_rank = 1;
EXCHANGE TABLES iracing_stg.stg_mv_session_results AND iracing.mv_session_results;