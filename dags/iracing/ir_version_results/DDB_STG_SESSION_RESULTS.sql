CREATE OR REPLACE TABLE STG_SESSION_RESULTS AS
SELECT
    subsession_id,
    simsession_number,
    simsession_name,
    simsession_type,
    simsession_type_name,
    r.unnest.cust_id as cust_id,
    r.unnest.display_name as display_name,
    r.unnest.aggregate_champ_points as aggregate_champ_points,
    r.unnest.ai as ai,
    r.unnest.average_lap as average_lap,
    r.unnest.best_lap_num as best_lap_num,
    r.unnest.best_lap_time as best_lap_time,
    r.unnest.best_nlaps_num as best_nlaps_num,
    r.unnest.best_nlaps_time as best_nlaps_time,
    r.unnest.best_qual_lap_at as best_qual_lap_at,
    r.unnest.best_qual_lap_num as best_qual_lap_num,
    r.unnest.best_qual_lap_time as best_qual_lap_time,
    r.unnest.car_class_id as car_class_id,
    r.unnest.car_class_name as car_class_name,
    r.unnest.car_class_short_name as car_class_short_name,
    r.unnest.car_id as car_id,
    r.unnest.car_name as car_name,
    r.unnest.champ_points as champ_points,
    r.unnest.class_interval as class_interval,
    r.unnest.club_id as club_id,
    r.unnest.club_name as club_name,
    r.unnest.club_points as club_points,
    r.unnest.club_shortname as club_shortname,
    r.unnest.country_code as country_code,
    r.unnest.division as division,
    r.unnest.division_name as division_name,
    r.unnest.drop_race as drop_race,
    r.unnest.finish_position as finish_position,
    r.unnest.finish_position_in_class as finish_position_in_class,
    r.unnest.friend as friend,
    r.unnest.incidents as incidents,
    r.unnest.interval as interval,
    r.unnest.laps_complete as laps_complete,
    r.unnest.laps_lead as laps_lead,
    r.unnest.league_agg_points as league_agg_points,
    r.unnest.league_points as league_points,
    r.unnest.license_change_oval as license_change_oval,
    r.unnest.license_change_road as license_change_road,
    r.unnest.max_pct_fuel_fill as max_pct_fuel_fill,
    r.unnest.multiplier as multiplier,
    r.unnest.new_cpi as new_cpi,
    r.unnest.new_license_level as new_license_level,
    r.unnest.new_sub_level as new_sub_level,
    r.unnest.new_ttrating as new_ttrating,
    r.unnest.newi_rating as newi_rating,
    r.unnest.old_cpi as old_cpi,
    r.unnest.old_license_level as old_license_level,
    r.unnest.old_sub_level as old_sub_level,
    r.unnest.old_ttrating as old_ttrating,
    r.unnest.oldi_rating as oldi_rating,
    r.unnest.opt_laps_complete as opt_laps_complete,
    r.unnest.position as position,
    r.unnest.qual_lap_time as qual_lap_time,
    r.unnest.reason_out as reason_out,
    r.unnest.reason_out_id as reason_out_id,
    r.unnest.starting_position as starting_position,
    r.unnest.starting_position_in_class as starting_position_in_class,
    r.unnest.watched as watched,
    r.unnest.weight_penalty_kg as weight_penalty_kg,
    --r.unnest.driver_results as driver_results
FROM (
    SELECT subsession_id,
           sr.unnest.simsession_number,
           sr.unnest.simsession_name,
           sr.unnest.simsession_type,
           sr.unnest.simsession_type_name,
           sr.unnest.results
    FROM read_json(
            'temp/*.json',
            ignore_errors = true
        ) results,
    UNNEST(results.session_results) sr
) results,
UNNEST(results.results) r